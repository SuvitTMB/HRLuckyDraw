<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Font (Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hidden { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideInRight 0.3s ease-out forwards; }
        
        .table-compact tr { height: 30px; }
        .table-compact td { padding-top: 0px; padding-bottom: 0px; vertical-align: middle; line-height: 1; }
        #table-body tr:nth-child(even), #label-table-body tr:nth-child(even), #log-table-body tr:nth-child(even) { background-color: #f8fafc; }
        #table-body tr:nth-child(odd), #label-table-body tr:nth-child(odd), #log-table-body tr:nth-child(odd) { background-color: #ffffff; }
        .table-compact th { height: 35px; padding-top: 4px; padding-bottom: 4px; }
        .custom-scroll-dark::-webkit-scrollbar { width: 6px; }
        .custom-scroll-dark::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        .custom-scroll-dark::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col md:flex-row overflow-hidden">

    <div id="toast-container" class="fixed top-6 right-6 z-50 flex flex-col gap-3 w-80 pointer-events-none"></div>

    <!-- Sidebar -->
    <aside class="w-full md:w-64 bg-slate-800 text-white flex-shrink-0 flex flex-col h-screen overflow-y-auto z-20 shadow-xl">
        <div class="p-6 border-b border-slate-700 flex items-center gap-3">
            <div class="bg-blue-500 p-2 rounded-lg">
                <i data-lucide="layout-dashboard" width="24" height="24"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg">HR Admin</h1>
                <p class="text-xs text-slate-400">ระบบจัดการข้อมูลพนักงาน</p>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="window.app.switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all font-bold">
                <i data-lucide="pie-chart" width="20"></i> ภาพรวม (Dashboard)
            </button>
            <button onclick="window.app.switchTab('data')" id="nav-data" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all font-bold">
                <i data-lucide="table" width="20"></i> ข้อมูลลงทะเบียน
            </button>
            <button onclick="window.app.switchTab('winners')" id="nav-winners" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all font-bold">
                <i data-lucide="trophy" width="20"></i> รางวัลโชคชั้นที่ 2
            </button>
            <div class="pt-4 mt-4 border-t border-slate-700">
                <p class="px-4 text-xs text-slate-500 mb-2 font-bold uppercase tracking-wider">Management</p>
                <button onclick="window.app.switchTab('import')" id="nav-import" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all font-bold">
                    <i data-lucide="database" width="20"></i> จัดการข้อมูล (Import)
                </button>
                <button onclick="window.app.switchTab('labels')" id="nav-labels" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all font-bold">
                    <i data-lucide="tags" width="20"></i> ระบบจัดการฉลาก
                </button>
                <button onclick="window.app.switchTab('logs')" id="nav-logs" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all font-bold">
                    <i data-lucide="file-search" width="20"></i> ตรวจสอบรายการ
                </button>
                <button onclick="window.app.switchTab('qrcode-in')" id="nav-qrcode-in" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-700/50 hover:text-white transition-all font-bold">
                    <i data-lucide="qr-code" width="20"></i> QR Code ฮั่งเปา
                </button>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-700">
            <div class="bg-slate-900 rounded-xl p-4 font-bold">
                <p class="text-xs text-slate-500 mb-1">สถานะระบบ</p>
                <div class="flex items-center gap-2">
                    <div id="status-indicator" class="w-2 h-2 bg-red-500 rounded-full"></div>
                    <span id="status-text" class="text-sm text-slate-400">Connecting...</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shadow-sm z-10">
            <h2 id="page-title" class="text-xl font-bold text-slate-800">แดชบอร์ด</h2>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block font-bold">
                    <p class="text-sm text-slate-700">ผู้ดูแลระบบ</p>
                    <p class="text-xs text-slate-500" id="current-time">--:--:--</p>
                </div>
                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold">A</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 bg-slate-50 relative" id="main-scroll">
            
            <!-- VIEW 1: DASHBOARD -->
            <div id="view-dashboard" class="view-section hidden space-y-6 fade-in-up">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group font-bold">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="users" width="60" height="60" class="text-blue-600"></i></div>
                        <p class="text-slate-500 text-sm">สมาชิกทั้งหมด</p>
                        <h3 id="stat-checkin" class="text-2xl font-bold text-slate-800 mt-2">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group font-bold">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="user-check" width="60" height="60" class="text-green-600"></i></div>
                        <p class="text-slate-500 text-sm">สมาชิกลงทะเบียน</p>
                        <h3 id="stat-checkout" class="text-2xl font-bold text-slate-800 mt-2">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col relative overflow-hidden group font-bold">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="percent" width="60" height="60" class="text-orange-400"></i></div>
                        <p class="text-slate-500 text-sm">% ลงทะเบียน</p>
                        <h3 id="stat-percent" class="text-2xl font-bold text-slate-800 mt-2">0%</h3>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-stretch">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-full flex flex-col">
                        <h3 class="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2"><div class="w-3 h-3 bg-indigo-500 rounded-full"></div> สัดส่วนการลงทะเบียน</h3>
                        <div class="h-64 flex justify-center"><canvas id="registrationChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex flex-col h-full max-h-[730px]"> 
                        <h3 class="font-bold text-lg text-slate-700 mb-4">กิจกรรมล่าสุด</h3>
                        <div id="recent-activity-list" class="space-y-4 overflow-y-auto pr-2 flex-1 text-base font-bold text-slate-700"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="activity" width="20" class="text-blue-500"></i> สถิติการลงทะเบียนรายชั่วโมง</h3>
                    <div class="h-64"><canvas id="realtimeLineChart"></canvas></div>
                </div>
            </div>

            <!-- VIEW 2: DATA TABLE -->
            <div id="view-data" class="view-section hidden space-y-6 fade-in-up">
                 <div id="data-summary-container" class="grid grid-cols-1 md:grid-cols-5 gap-4"></div>
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center bg-slate-200 gap-4">
                        <h3 class="font-bold text-lg text-slate-800">ข้อมูลการลงทะเบียนทั้งหมด</h3>
                        <div class="flex items-center gap-4 flex-wrap justify-end">
                             <div class="flex items-center gap-2 font-bold">
                                <label class="text-sm text-slate-600">กรอง Reward:</label>
                                <select id="filter-data-reward" onchange="window.app.onDataRewardFilterChange(this.value)" class="bg-white border border-slate-200 text-slate-600 text-sm rounded-lg p-2 w-48 shadow-sm">
                                    <option value="">-- ทั้งหมด --</option>
                                </select>
                             </div>
                             <div class="flex items-center gap-2 font-bold">
                                <label class="text-sm text-slate-600">แสดง:</label>
                                <select id="rows-per-page" onchange="window.app.changeRowsLimit(this.value)" class="bg-white border border-slate-200 text-slate-600 text-sm rounded-lg p-2">
                                    <option value="20">20 แถว</option>
                                    <option value="50" selected>50 แถว</option>
                                    <option value="100">100 แถว</option>
                                </select>
                             </div>
                             <input type="text" id="search-data" oninput="window.app.handleSearch(this.value)" placeholder="ค้นหาชื่อ..." class="px-4 py-2 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-100 font-bold">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-compact">
                            <thead class="bg-slate-200 text-slate-700 font-bold border-b border-slate-100 text-base">
                                <tr>
                                    <th class="px-6 py-4 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeSort('no')">NO. <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 py-4 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeSort('EmpName')">ชื่อ-นามสกุล <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 py-4 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeSort('Reward')">Group <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 py-4 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeSort('DateCheck')">Login <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 py-4 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeSort('DateLogin')">สุ่มครั้งที่ 1 <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 py-4 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeSort('DateReward')">สุ่มครั้งที่ 2 <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 py-4 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeSort('StatusReward')">รางวัล <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 py-4 text-right">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-100 text-sm font-normal text-slate-700"></tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t bg-slate-50 flex justify-between items-center px-6">
                        <p class="text-sm text-slate-400 font-bold" id="data-table-info"></p>
                        <div class="flex gap-4 items-center">
                            <button onclick="window.app.exportDataToCSV()" class="px-4 py-1.5 bg-emerald-600 text-white rounded-lg font-bold text-xs hover:bg-emerald-700 flex items-center gap-2 shadow-sm transition">
                                <i data-lucide="download" width="14"></i> Download CSV File
                            </button>
                            <div class="flex gap-2" id="pagination-controls"></div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- VIEW 3: WINNERS -->
            <div id="view-winners" class="view-section hidden space-y-6 fade-in-up">
                 <div id="winners-container" class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-[80%] mx-auto font-bold"></div>
            </div>

            <!-- VIEW 4: IMPORT -->
            <div id="view-import" class="view-section hidden space-y-6 fade-in-up font-bold">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 font-bold">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2 font-bold"><i data-lucide="upload-cloud" width="20" class="text-blue-600"></i> นำเข้าข้อมูล (JSON/CSV)</h3>
                        <p class="text-sm text-slate-500 mb-4">ระบบจะรันหมายเลข <code>no</code> ให้อัตโนมัติทุกครั้งที่นำเข้าใหม่</p>
                        <div class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center cursor-pointer hover:bg-slate-50 transition" onclick="document.getElementById('file-upload').click()">
                            <i data-lucide="file-up" width="40" class="mx-auto text-slate-400 mb-2"></i>
                            <p class="text-sm font-bold text-slate-600">คลิกเพื่อเลือกไฟล์ หรือลากมาวางที่นี่</p>
                            <input type="file" id="file-upload" class="hidden" accept=".json,.csv" onchange="window.app.handleFileSelect(event)">
                        </div>
                        <div id="file-info" class="hidden bg-blue-50 p-3 rounded-lg flex items-center justify-between text-sm text-blue-700 mt-4">
                            <span id="file-name" class="font-bold"></span>
                            <button onclick="window.app.clearFileSelection()"><i data-lucide="x" width="16"></i></button>
                        </div>
                        <button onclick="window.app.processImport()" id="btn-import" disabled class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mt-4 hover:bg-blue-700 transition shadow-lg shadow-blue-100 font-bold">เริ่มนำเข้าข้อมูล</button>
                        <div id="import-progress" class="hidden w-full bg-slate-200 rounded-full h-2.5 mt-4">
                            <div id="import-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 font-bold">
                         <h3 class="font-bold text-lg text-slate-800 mb-4 font-bold">จัดการระบบ</h3>
                         <div class="space-y-4">
                             <div class="bg-slate-50 p-4 rounded-xl flex justify-between items-center">
                                <div><p class="text-sm text-slate-500 font-bold">พนักงานในระบบ</p><h2 class="text-2xl font-bold" id="manage-total-docs">0</h2></div>
                                <i data-lucide="database" class="text-slate-300" width="40"></i>
                             </div>
                             <div class="grid grid-cols-2 gap-2">
                                <button onclick="window.app.openResetModal()" class="w-full py-3 border border-orange-300 text-orange-700 rounded-xl font-bold text-sm hover:bg-orange-50 transition">Reset Register</button>
                                <button onclick="window.app.openDeleteModal()" class="w-full py-3 border border-red-300 text-red-700 rounded-xl font-bold text-sm hover:bg-red-50 transition">Delete All</button>
                             </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 5: LABELS -->
            <div id="view-labels" class="view-section hidden space-y-6 fade-in-up">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 font-bold">
                    <h3 class="font-bold text-lg text-slate-800 mb-6 flex items-center gap-2"><i data-lucide="tags" width="20" class="text-indigo-600"></i> ระบบจัดการฉลาก</h3>
                    <div id="label-summary-container" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                        <!-- Stats boxes populated in init() -->
                        <div class="bg-rose-600 text-white p-5 rounded-2xl flex flex-col justify-center shadow-xl border border-white/10 transition-all hover:scale-[1.02]">
                            <p class="text-[11px] font-bold uppercase tracking-wider opacity-80">กลุ่ม 1,000</p>
                            <h4 id="card-total-1000" class="text-2xl font-black mt-1">0 <span class="text-xs font-normal opacity-70">สลาก</span></h4>
                            <div class="mt-2 flex justify-between items-baseline font-bold"><span class="text-xs"><span id="card-used-1000">0</span> <span class="opacity-70 font-normal">ใช้แล้ว</span></span><span class="text-sm font-black" id="card-percent-1000">0%</span></div>
                            <div class="w-full bg-white/30 h-1 mt-2 rounded-full overflow-hidden"><div id="card-bar-1000" class="bg-white h-1 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                        </div>
                        <div class="bg-emerald-600 text-white p-5 rounded-2xl flex flex-col justify-center shadow-xl border border-white/10 transition-all hover:scale-[1.02]">
                            <p class="text-[11px] font-bold uppercase tracking-wider opacity-80">กลุ่ม 2,000</p>
                            <h4 id="card-total-2000" class="text-2xl font-black mt-1">0 <span class="text-xs font-normal opacity-70">สลาก</span></h4>
                            <div class="mt-2 flex justify-between items-baseline font-bold"><span class="text-xs"><span id="card-used-2000">0</span> <span class="opacity-70 font-normal">ใช้แล้ว</span></span><span class="text-sm font-black" id="card-percent-2000">0%</span></div>
                            <div class="w-full bg-white/30 h-1 mt-2 rounded-full overflow-hidden"><div id="card-bar-2000" class="bg-white h-1 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                        </div>
                        <div class="bg-sky-600 text-white p-5 rounded-2xl flex flex-col justify-center shadow-xl border border-white/10 transition-all hover:scale-[1.02]">
                            <p class="text-[11px] font-bold uppercase tracking-wider opacity-80">กลุ่ม 3,000</p>
                            <h4 id="card-total-3000" class="text-2xl font-black mt-1">0 <span class="text-xs font-normal opacity-70">สลาก</span></h4>
                            <div class="mt-2 flex justify-between items-baseline font-bold"><span class="text-xs"><span id="card-used-3000">0</span> <span class="opacity-70 font-normal">ใช้แล้ว</span></span><span class="text-sm font-black" id="card-percent-3000">0%</span></div>
                            <div class="w-full bg-white/30 h-1 mt-2 rounded-full overflow-hidden"><div id="card-bar-3000" class="bg-white h-1 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                        </div>
                        <div class="bg-amber-600 text-white p-5 rounded-2xl flex flex-col justify-center shadow-xl border border-white/10 transition-all hover:scale-[1.02]">
                            <p class="text-[11px] font-bold uppercase tracking-wider opacity-80">กลุ่ม 4,000</p>
                            <h4 id="card-total-4000" class="text-2xl font-black mt-1">0 <span class="text-xs font-normal opacity-70">สลาก</span></h4>
                            <div class="mt-2 flex justify-between items-baseline font-bold"><span class="text-xs"><span id="card-used-4000">0</span> <span class="opacity-70 font-normal">ใช้แล้ว</span></span><span class="text-sm font-black" id="card-percent-4000">0%</span></div>
                            <div class="w-full bg-white/30 h-1 mt-2 rounded-full overflow-hidden"><div id="card-bar-4000" class="bg-white h-1 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                        </div>
                    </div>
                    <div class="flex flex-col md:flex-row gap-3">
                        <button onclick="window.app.openDeleteLabelsModal()" class="flex-1 min-h-[50px] bg-red-50 text-red-600 border border-red-200 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-red-100 transition shadow-sm group">
                            <i data-lucide="trash-2" width="20"></i> ลบฉลากทั้งหมด
                        </button>
                        <button onclick="window.app.openCreateLabelsModal()" class="flex-1 min-h-[50px] bg-indigo-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 group">
                            <i data-lucide="plus-circle" width="20"></i> สร้างฉลากใหม่
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mt-6">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-lg">ตารางแสดงผลฉลากตามกลุ่ม</h3>
                        <div class="flex items-center gap-3 font-bold">
                            <label class="text-sm text-slate-600">เลือกกลุ่มรางวัล:</label>
                            <select id="label-group-select" onchange="window.app.onLabelGroupChange(this.value)" class="w-48 p-2 border rounded-xl shadow-sm outline-none focus:ring-2 focus:ring-indigo-100 text-sm">
                                <option value="">รางวัลทั้งหมด</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-base table-compact">
                            <thead class="bg-slate-200 text-slate-700 font-bold uppercase text-xs">
                                <tr>
                                    <th class="px-6 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeLabelSort('CardNo')">ลำดับที่ <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeLabelSort('Reward')">Reward (กลุ่ม) <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeLabelSort('rewardname')">ของรางวัล (Reward Name) <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeLabelSort('EmpName')">ผู้รับรางวัล (EmpName) <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 cursor-pointer hover:bg-slate-300 transition" onclick="window.app.changeLabelSort('Datetime')">Datetime <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-6 text-right">Admin</th>
                                </tr>
                            </thead>
                            <tbody id="label-table-body" class="divide-y divide-slate-100 font-normal text-sm text-slate-700"></tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t bg-slate-50 flex justify-between items-center px-6">
                        <p class="text-sm text-slate-400 font-bold" id="label-table-info"></p>
                        <div class="flex gap-4 items-center">
                            <button onclick="window.app.exportLabelsToCSV()" class="px-4 py-1.5 bg-emerald-600 text-white rounded-lg font-bold text-xs hover:bg-emerald-700 flex items-center gap-2 shadow-sm transition">
                                <i data-lucide="download" width="14"></i> Download CSV File
                            </button>
                            <div class="flex gap-2" id="label-pagination-controls"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 6: LOGS -->
            <div id="view-logs" class="view-section hidden space-y-6 fade-in-up">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 font-bold">
                    <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2 font-bold"><i data-lucide="file-search" width="20" class="text-blue-600"></i> ตรวจสอบรายการ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-white">
                        <div class="bg-blue-600 p-4 rounded-xl flex justify-between items-center border border-white/10 shadow-xl">
                            <div>
                                <p class="text-xs font-bold uppercase tracking-wider opacity-80">จำนวนข้อมูลทั้งหมด</p>
                                <h2 class="text-3xl font-black" id="log-total-count">0</h2>
                            </div>
                            <i data-lucide="list" class="opacity-30" width="40"></i>
                        </div>
                        <div class="bg-rose-600 p-4 rounded-xl flex justify-between items-center border border-white/10 shadow-xl">
                            <div>
                                <p class="text-xs font-bold uppercase tracking-wider opacity-80">จัดการข้อมูล</p>
                                <button onclick="window.app.openDeleteLogsModal()" class="mt-2 px-4 py-2 bg-white text-rose-600 rounded-lg font-bold text-xs hover:bg-slate-100 transition shadow-lg flex items-center gap-2">
                                    <i data-lucide="trash-2" width="14"></i> ลบ Log File ทั้งหมด
                                </button>
                            </div>
                            <i data-lucide="alert-triangle" class="opacity-30" width="40"></i>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-slate-100">
                        <table class="w-full text-left table-compact">
                            <thead class="bg-slate-200 text-slate-700 font-bold text-sm">
                                <tr>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-slate-300" onclick="window.app.changeLogSort('index')">ลำดับที่ <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-slate-300" onclick="window.app.changeLogSort('citizenId')">citizenId <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-slate-300" onclick="window.app.changeLogSort('EmpName')">EmpName <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-slate-300" onclick="window.app.changeLogSort('StatusReg')">StatusReg <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-slate-300" onclick="window.app.changeLogSort('deviceID')">deviceID <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                    <th class="px-4 py-3 cursor-pointer hover:bg-slate-300" onclick="window.app.changeLogSort('Datetime')">Datetime <i data-lucide="chevrons-up-down" class="inline w-3"></i></th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body" class="divide-y divide-slate-100 text-sm font-normal text-slate-700"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-4">
                        <button onclick="window.app.exportLogsToCSV()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg font-bold text-sm hover:bg-emerald-700 flex items-center gap-2 shadow-lg shadow-emerald-100 transition font-bold">
                            <i data-lucide="download" width="16"></i> Download CSV File
                        </button>
                        <div class="flex gap-2" id="log-pagination-controls"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW 7: QR CODE -->
            <div id="view-qrcode-in" class="view-section hidden space-y-6 fade-in-up">
                 <div class="bg-white p-10 rounded-2xl shadow-lg border border-slate-100 flex flex-col items-center justify-center text-center min-h-[60vh]">
                    <h2 class="text-2xl font-bold text-blue-800 mb-2 font-bold text-2xl text-center">ลงทะเบียน</h2>
                    <div class="bg-white p-4 rounded-xl border border-slate-300 mb-6 mt-6">
                        <img src="./images/QRCodeHR2026.png" alt="QR" class="w-80 h-80 object-contain mx-auto" onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://suvittmb.github.io/HRLuckyDraw/hr2026.html'">
                    </div>
                    <button onclick="window.print()" class="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm border flex items-center gap-2 transition mx-auto font-bold"><i data-lucide="printer" width="16"></i> พิมพ์หน้านี้</button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Confirm Modal -->
    <div id="label-confirm-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop font-bold">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[90%] md:max-w-[40%] p-8 text-center transition-all duration-300 font-bold">
            <div id="label-modal-icon" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 font-bold"></div>
            <h3 id="label-modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="label-modal-message" class="text-slate-500 text-sm mb-6"></p>
            <div id="label-modal-input-container" class="hidden mb-4"><input type="text" id="label-modal-input" class="w-full p-3 border rounded-xl text-center font-bold outline-none focus:ring-2"></div>
            <div class="flex gap-3 font-bold">
                <button onclick="window.app.closeLabelModal()" class="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-slate-500">ยกเลิก</button>
                <button id="label-modal-confirm-btn" class="flex-1 py-3 rounded-xl bg-slate-800 text-white font-bold transition"></button>
            </div>
        </div>
    </div>

    <!-- Edit Reward Modal -->
    <div id="edit-reward-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop font-bold">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center font-bold">
            <h3 class="text-xl font-bold mb-2 text-slate-800">แก้ไขของรางวัล</h3>
            <p class="text-sm text-slate-500 mb-4 text-center">ระบุชื่อรางวัลสำหรับฉลากลำดับนี้</p>
            <input type="text" id="edit-reward-input" class="w-full p-3 border rounded-xl text-center font-bold outline-none focus:ring-2 focus:ring-indigo-100 mb-6 font-bold">
            <div class="flex gap-3 font-bold">
                <button onclick="window.app.closeEditRewardModal()" class="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-slate-500">ยกเลิก</button>
                <button id="edit-reward-confirm-btn" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, serverTimestamp, onSnapshot, addDoc, deleteDoc, writeBatch, deleteField, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // CONFIG
        const TARGET_COLLECTION_NAME = 'Outsources';
        const CARDS_COLLECTION_NAME = 'Outsources_card';
        const LOGS_COLLECTION_NAME = 'Outsources_log';
        
        const isSandboxEnv = typeof __firebase_config !== 'undefined';
        let firebaseConfig, finalCollectionPath, cardCollectionPath, logCollectionPath;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (isSandboxEnv) {
            firebaseConfig = JSON.parse(__firebase_config);
            finalCollectionPath = `artifacts/${appId}/public/data/${TARGET_COLLECTION_NAME}`;
            cardCollectionPath = `artifacts/${appId}/public/data/${CARDS_COLLECTION_NAME}`;
            logCollectionPath = `artifacts/${appId}/public/data/${LOGS_COLLECTION_NAME}`;
        } else {
            firebaseConfig = { apiKey: "AIzaSyAgWMzWcZPzyzoBu5eQzj2y59nKsxTWurQ", authDomain: "ttb-register.firebaseapp.com", projectId: "ttb-register", storageBucket: "ttb-register.firebasestorage.app", messagingSenderId: "1070273157855", appId: "1:1070273157855:web:5c8120e1df27e233d8676a" };
            finalCollectionPath = TARGET_COLLECTION_NAME;
            cardCollectionPath = CARDS_COLLECTION_NAME;
            logCollectionPath = LOGS_COLLECTION_NAME;
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            users: [], cards: [], logs: [], 
            activeTab: 'dashboard', searchTerm: '', rowsPerPage: 50, currentPage: 1, sortBy: 'no', sortOrder: 'asc',
            hourlyData: Array(24).fill(0), selectedLabelGroup: '', labelPage: 1, labelRowsPerPage: 50, labelSortKey: 'CardNo', labelSortOrder: 'asc',
            logPage: 1, logRowsPerPage: 50, logSortKey: 'Datetime', logSortOrder: 'desc',
            selectedDataReward: ''
        };

        const formatDate = (val) => {
            if (!val) return '-';
            try {
                if (val.toDate) {
                    const d = val.toDate();
                    return d.toLocaleDateString('th-TH') + ' ' + d.toLocaleTimeString('th-TH');
                }
                const d = new Date(val);
                if (!isNaN(d.getTime())) return d.toLocaleDateString('th-TH') + ' ' + d.toLocaleTimeString('th-TH');
            } catch(e) {}
            return val;
        };

        const normalizeReward = (val) => String(val || "").replace(/,/g, '').trim();

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function chunkArray(a, s) { const r = []; for (let i = 0; i < a.length; i += s) r.push(a.slice(i, i + s)); return r; }

        function csvToJson(csv) {
            const lines = csv.split('\n');
            if(lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const data = line.split(',');
                if (data.length < headers.length) return null;
                return headers.reduce((obj, nextKey, index) => { 
                    obj[nextKey] = data[index] ? data[index].trim() : ''; 
                    return obj; 
                }, {});
            }).filter(x => x);
        }

        window.app = {
            showToast: (m, t='success') => {
                const c = document.getElementById('toast-container');
                if(!c) return;
                const toast = document.createElement('div');
                toast.className = `bg-white border-l-4 ${t === 'success' ? 'border-green-500' : 'border-red-500'} p-4 rounded-xl shadow-lg toast-enter pointer-events-auto`;
                toast.innerHTML = `<span class="text-sm font-bold text-slate-700">${m}</span>`;
                c.appendChild(toast);
                setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
            },

            switchTab: (tabName) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${tabName}`);
                if(target) target.classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-slate-700', 'text-white'));
                const nav = document.getElementById(`nav-${tabName}`);
                if(nav) nav.classList.add('bg-slate-700', 'text-white');
                state.activeTab = tabName;
                const titles = { 'dashboard':'ภาพรวมระบบ', 'data':'ข้อมูลลงทะเบียน', 'winners':'รางวัลโชคชั้นที่ 2', 'import':'จัดการข้อมูล', 'labels':'ระบบจัดการฉลาก', 'qrcode-in':'QR Code ฮั่งเปา', 'logs': 'ตรวจสอบรายการ' };
                document.getElementById('page-title').innerText = titles[tabName] || tabName;
                if(tabName === 'labels') window.app.renderLabelTable();
                if(tabName === 'data') { window.app.renderDataSummary(); window.app.renderTable(); }
                if(tabName === 'winners') window.app.renderWinnersView();
                if(tabName === 'dashboard') window.app.refreshCharts();
                if(tabName === 'logs') window.app.renderLogTable();
                lucide.createIcons();
            },

            renderDataSummary: () => {
                const container = document.getElementById('data-summary-container');
                if (!container || state.activeTab !== 'data') return;
                const registeredTotal = state.users.filter(u => u.DateCheck && u.DateCheck !== "").length;
                const boxes = [];
                const themes = [
                    { bg: 'bg-blue-600', bar: 'bg-white/30', text: 'text-white' },
                    { bg: 'bg-indigo-600', bar: 'bg-white/30', text: 'text-white' },
                    { bg: 'bg-emerald-600', bar: 'bg-white/30', text: 'text-white' },
                    { bg: 'bg-amber-600', bar: 'bg-white/30', text: 'text-white' },
                    { bg: 'bg-rose-600', bar: 'bg-white/30', text: 'text-white' }
                ];

                boxes.push({ type: 'total', label: "สมาชิกทั้งหมด", total: state.users.length, registered: registeredTotal, percent: state.users.length > 0 ? Math.round((registeredTotal / state.users.length) * 100) : 0 });
                const targetGroups = ["1000", "2000", "3000", "4000"];
                targetGroups.forEach(target => {
                    const groupUsers = state.users.filter(u => normalizeReward(u.Reward) === target);
                    const regGroup = groupUsers.filter(u => u.DateCheck && u.DateCheck !== "").length;
                    boxes.push({ type: 'group', label: target, total: groupUsers.length, registered: regGroup, percent: groupUsers.length > 0 ? Math.round((regGroup / groupUsers.length) * 100) : 0 });
                });

                container.innerHTML = boxes.map((box, i) => {
                    const theme = themes[i % themes.length];
                    return `<div class="${theme.bg} p-5 rounded-2xl shadow-xl border border-white/10 flex flex-col transition-all hover:shadow-2xl hover:scale-[1.02] h-full ${theme.text} font-bold"><p class="text-[11px] font-bold uppercase tracking-wider opacity-80">${box.type === 'total' ? box.label : 'กลุ่มรางวัล ' + box.label}</p><h3 class="text-3xl font-black mt-1 leading-tight">${box.total.toLocaleString()} <span class="text-xs font-normal opacity-70">ราย</span></h3><div class="mt-2 flex justify-between items-baseline font-bold"><span class="text-sm">${box.registered.toLocaleString()} <span class="text-[10px] opacity-70 font-normal">ลงทะเบียนแล้ว</span></span><span class="text-lg font-black">${box.percent}%</span></div><div class="w-full ${theme.bar} h-1.5 mt-auto rounded-full overflow-hidden mt-3 shadow-inner"><div class="bg-white h-1.5 rounded-full transition-all duration-1000" style="width: ${box.percent}%"></div></div></div>`;
                }).join('');
            },

            renderWinnersView: () => {
                const c = document.getElementById('winners-container');
                if(!c || state.activeTab !== 'winners') return;
                const prizeGroups = ["1000", "2000", "3000", "4000"];
                const themes = { "1000": "rose", "2000": "emerald", "3000": "sky", "4000": "amber" };
                c.innerHTML = prizeGroups.map(id => {
                    const color = themes[id] || "blue";
                    const gCards = state.cards.filter(x => normalizeReward(x.Reward) === id);
                    const gUsers = state.users.filter(x => normalizeReward(x.Reward) === id);
                    const gPrizes = [...new Set(gCards.map(x => x.rewardname).filter(r => r && r.trim() !== ""))];
                    const drawn = gCards.filter(x => x.Datetime && x.Datetime !== "");
                    const validWinners = drawn.filter(x => x.rewardname && x.rewardname.trim() !== "");
                    
                    const winnersHtml = (validWinners.length === 0) ? '<div class="text-base text-slate-400 py-6 text-center italic">ยังไม่มีผู้ได้รับรางวัล</div>' : validWinners.map(x => `<div class="flex flex-col py-2 border-b border-slate-50 last:border-0 px-2 font-bold"><span class="text-slate-800 text-lg">${x.EmpName || '---'}</span><span class="text-xs text-${color}-600">${x.rewardname}</span><span class="text-[9px] text-slate-300 font-normal mt-0.5">${formatDate(x.Datetime)}</span></div>`).join('');
                    
                    return `<div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 flex flex-col overflow-hidden transition-all hover:shadow-lg"><div class="bg-${color}-500 text-white p-3 text-center"><p class="text-[13px] font-black opacity-80 tracking-widest uppercase">กลุ่มรางวัล</p><h4 class="text-xl font-black">${id} บาท</h4></div><div class="bg-${color}-50 p-3 border-b text-center"><div class="text-sm font-black text-${color}-700">${gPrizes.length > 0 ? gPrizes.join(', ') : '(ไม่มีของรางวัล)'}</div></div><div class="p-4 flex-1 overflow-y-auto max-h-[350px] custom-scroll-dark"><p class="text-[10px] text-slate-400 mb-2 font-bold uppercase tracking-tighter">รายชื่อผู้ได้รับรางวัลล่าสุด</p>${winnersHtml}</div><div class="bg-slate-50 p-5 border-t"><div class="flex justify-between items-center mb-1.5 font-bold"><span class="text-[12px] text-slate-500">สถิติการสุ่มรางวัล</span><span class="text-xs text-slate-700">${drawn.length} / ${gCards.length} ราย</span></div><div class="w-full bg-slate-200 rounded-full h-2"><div class="bg-${color}-500 h-2 rounded-full transition-all duration-1000" style="width: ${gCards.length?(drawn.length/gCards.length*100):0}%"></div></div><p class="text-[12px] text-slate-400 mt-2 text-right font-bold text-slate-600 italic">พนักงานในกลุ่มนี้: ${gUsers.length} คน</p></div></div>`;
                }).join('');
            },

            renderLabelTable: () => {
                const tbody = document.getElementById('label-table-body');
                const info = document.getElementById('label-table-info');
                const pagin = document.getElementById('label-pagination-controls');
                if(!tbody || state.activeTab !== 'labels') return;
                let filtered = state.selectedLabelGroup === '' ? [...state.cards] : state.cards.filter(c => normalizeReward(c.Reward) === state.selectedLabelGroup);
                
                filtered.sort((a, b) => {
                    let vA = a[state.labelSortKey]; let vB = b[state.labelSortKey];
                    if (state.labelSortKey === 'CardNo' || state.labelSortKey === 'Reward') {
                        const nA = parseFloat(String(vA || "").replace(/,/g, '')) || 0;
                        const nB = parseFloat(String(vB || "").replace(/,/g, '')) || 0;
                        return state.labelSortOrder === 'asc' ? nA - nB : nB - nA;
                    }
                    if (state.labelSortKey === 'Datetime') {
                        const tA = vA?.toDate ? vA.toDate().getTime() : (new Date(vA).getTime() || 0);
                        const tB = vB?.toDate ? vB.toDate().getTime() : (new Date(vB).getTime() || 0);
                        return state.labelSortOrder === 'asc' ? tA - tB : tB - tA;
                    }
                    return state.labelSortOrder === 'asc' ? String(vA || "").localeCompare(String(vB || ""), 'th', {numeric: true}) : String(vB || "").localeCompare(String(vA || ""), 'th', {numeric: true});
                });

                const total = filtered.length;
                const totalPages = Math.ceil(total / 50) || 1;
                if (state.labelPage > totalPages) state.labelPage = totalPages;
                const pageData = filtered.slice((state.labelPage - 1) * 50, state.labelPage * 50);
                
                if(info) info.innerText = `แสดงรายการที่ ${(state.labelPage-1)*50+1} - ${Math.min(state.labelPage*50, total)} จากทั้งหมด ${total}`;
                if(pagin) pagin.innerHTML = `<button onclick="window.app.changeLabelPage(-1)" class="px-3 py-1 bg-white border rounded-md text-sm hover:bg-slate-50 font-bold" ${state.labelPage <= 1 ? 'disabled' : ''}>Prev</button><span class="text-sm self-center font-bold px-2">หน้า ${state.labelPage}/${totalPages}</span><button onclick="window.app.changeLabelPage(1)" class="px-3 py-1 bg-white border rounded-md text-sm hover:bg-slate-50 font-bold" ${state.labelPage >= totalPages ? 'disabled' : ''}>Next</button>`;
                
                tbody.innerHTML = pageData.map(c => {
                    const isDrawn = !!c.Datetime;
                    const rewardNameEscaped = (c.rewardname || '').replace(/'/g, "\\'");
                    return `<tr class="hover:bg-indigo-50/30 transition border-b border-slate-50 font-normal text-sm text-slate-700 font-bold"><td class="px-6 font-mono text-slate-500">${c.CardNo || '-'}</td><td class="px-6">${c.Reward || '-'}</td><td class="px-6 text-indigo-600 font-bold font-bold">${c.rewardname || '-'}</td><td class="px-6 font-bold text-slate-800 font-bold">${c.EmpName || '-'}</td><td class="px-6 text-slate-500 font-bold">${formatDate(c.Datetime)}</td><td class="px-6 text-right"><div class="flex items-center justify-end gap-2"><button onclick="${!isDrawn ? `window.app.openEditRewardModal('${c.id}', '${rewardNameEscaped}')` : ''}" class="text-indigo-600 font-bold text-xs p-1 px-2 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition ${isDrawn ? 'opacity-20 cursor-not-allowed' : ''}" ${isDrawn ? 'disabled' : ''}>แก้ไข</button><button onclick="${!!c.Datetime ? `window.app.resetLabelRecord('${c.id}')` : ''}" class="text-red-500 font-bold text-xs p-1 px-2 border border-red-200 rounded-lg ${!c.Datetime?'opacity-20 cursor-not-allowed':'hover:bg-red-50'} transition" ${!c.Datetime?'disabled':''}>ล้างผลสุ่ม</button></div></td></tr>`;
                }).join('');
                lucide.createIcons();
            },

            exportDataToCSV: () => {
                let filtered = state.users.filter(u => (u.EmpName || '').toLowerCase().includes(state.searchTerm) && (state.selectedDataReward === '' || String(u.Reward) === String(state.selectedDataReward)));
                if (filtered.length === 0) return window.app.showToast('ไม่มีข้อมูลสำหรับดาวน์โหลด', 'error');
                filtered.sort((a, b) => (parseFloat(a.no)||0) - (parseFloat(b.no)||0));
                const headers = ['NO.', 'ชื่อ-นามสกุล', 'Reward (Group)', 'Login (DateCheck)', 'สุ่มครั้งที่ 1 (DateLogin)', 'สุ่มครั้งที่ 2 (DateReward)', 'รางวัล (StatusReward)'];
                const rows = filtered.map(u => [u.no || '', u.EmpName || '', u.Reward || '', formatDate(u.DateCheck), formatDate(u.DateLogin), formatDate(u.DateReward), u.StatusReward || '']);
                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.map(val => `"${val}"`).join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `registration_data_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            exportLabelsToCSV: () => {
                let filtered = state.selectedLabelGroup === '' ? [...state.cards] : state.cards.filter(c => normalizeReward(c.Reward) === state.selectedLabelGroup);
                if (filtered.length === 0) return window.app.showToast('ไม่มีข้อมูลสำหรับดาวน์โหลด', 'error');
                filtered.sort((a, b) => (parseInt(a.CardNo) || 0) - (parseInt(b.CardNo) || 0));
                const headers = ['ลำดับที่', 'Reward (กลุ่ม)', 'ของรางวัล (Reward Name)', 'ผู้รับรางวัล (EmpName)', 'Datetime'];
                const rows = filtered.map(c => [c.CardNo || '', c.Reward || '', c.rewardname || '', c.EmpName || '', formatDate(c.Datetime)]);
                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.map(val => `"${val}"`).join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `labels_export_${state.selectedLabelGroup || 'all'}_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            renderLogTable: () => {
                const tbody = document.getElementById('log-table-body');
                const info = document.getElementById('log-pagination-controls');
                if(!tbody) return;
                let sortedLogs = [...state.logs];
                sortedLogs.sort((a,b) => {
                    let vA = a[state.logSortKey]; let vB = b[state.logSortKey];
                    if (state.logSortKey === 'Datetime') {
                        vA = a.Datetime?.toDate ? a.Datetime.toDate().getTime() : new Date(a.Datetime).getTime();
                        vB = b.Datetime?.toDate ? b.Datetime.toDate().getTime() : new Date(b.Datetime).getTime();
                    }
                    if (state.logSortKey === 'index') return state.logSortOrder === 'asc' ? 1 : -1;
                    return state.logSortOrder === 'asc' ? String(vA || "").localeCompare(String(vB || ""), 'th') : String(vB || "").localeCompare(String(vA || ""), 'th');
                });
                const total = sortedLogs.length;
                const totalPages = Math.ceil(total / 50) || 1;
                if (state.logPage > totalPages) state.logPage = totalPages;
                const pageData = sortedLogs.slice((state.logPage - 1) * 50, state.logPage * 50);
                if(document.getElementById('log-total-count')) document.getElementById('log-total-count').innerText = total.toLocaleString();
                tbody.innerHTML = pageData.map((l, i) => `<tr class="hover:bg-blue-50/50 transition font-bold text-slate-700 text-sm"><td class="px-4 py-3 font-mono text-slate-400 font-normal text-sm">${(state.logPage-1)*50 + i + 1}</td><td class="px-4 py-3 font-mono text-xs text-slate-500 font-normal text-sm truncate max-w-[120px]" title="${l.citizenId}">${l.citizenId || '-'}</td><td class="px-4 py-3 font-normal text-sm text-slate-700 font-bold">${l.EmpName || '-'}</td><td class="px-4 py-3 font-bold"><span class="px-2 py-0.5 rounded-full text-[10px] bg-blue-100 text-blue-600 font-bold">${l.StatusReg || 'Success'}</span></td><td class="px-4 py-3 font-mono text-xs text-slate-400 font-normal text-sm">${l.deviceID || '-'}</td><td class="px-4 py-3 text-slate-500 font-normal text-sm">${formatDate(l.Datetime)}</td></tr>`).join('');
                if(info) info.innerHTML = `<button onclick="window.app.changeLogPage(-1)" class="px-3 py-1 bg-white border rounded-md text-xs hover:bg-slate-50 font-bold" ${state.logPage <= 1 ? 'disabled' : ''}>Prev</button><span class="text-xs font-bold px-2">Page ${state.logPage}/${totalPages}</span><button onclick="window.app.changeLogPage(1)" class="px-3 py-1 bg-white border rounded-md text-xs hover:bg-slate-50 font-bold" ${state.logPage >= totalPages ? 'disabled' : ''}>Next</button>`;
                lucide.createIcons();
            },

            openDeleteLogsModal: () => {
                window.app.showLabelModal('Delete', 'ลบประวัติรายการทั้งหมด?', 'พิมพ์ Delete เพื่อลบประวัติ Log การทำรายการทั้งหมดถาวร', 'red', async () => {
                    try {
                        const snap = await getDocs(collection(db, logCollectionPath));
                        const batchSize = 400;
                        const chunks = chunkArray(snap.docs, batchSize);
                        for(const chunk of chunks) {
                            const batch = writeBatch(db);
                            chunk.forEach(d => batch.delete(d.ref));
                            await batch.commit();
                        }
                        window.app.showToast('ลบประวัติ Log เรียบร้อยแล้ว');
                    } catch(e) { window.app.showToast('เกิดข้อผิดพลาด', 'error'); }
                });
            },

            changeLogSort: (k) => {
                state.logSortOrder = (state.logSortKey === k) ? (state.logSortOrder === 'asc' ? 'desc' : 'asc') : 'desc';
                state.logSortKey = k;
                window.app.renderLogTable();
            },

            exportLogsToCSV: () => {
                if (state.logs.length === 0) return window.app.showToast('ไม่มีข้อมูลสำหรับดาวน์โหลด', 'error');
                const headers = ['ลำดับที่', 'citizenId', 'EmpName', 'StatusReg', 'deviceID', 'Datetime'];
                const rows = state.logs.map((l, idx) => [idx + 1, `\t${l.citizenId || ''}`, l.EmpName || '', l.StatusReg || 'Success', l.deviceID || '', formatDate(l.Datetime)]);
                const csvContent = "\uFEFF" + [headers, ...rows].map(e => e.map(val => `"${val}"`).join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `outsources_logs_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            onDataRewardFilterChange: (v) => { state.selectedDataReward = v; state.currentPage = 1; window.app.renderTable(); },
            handleSearch: (v) => { state.searchTerm = v.toLowerCase(); state.currentPage = 1; window.app.renderTable(); },
            changeRowsLimit: (v) => { state.rowsPerPage = parseInt(v); state.currentPage = 1; window.app.renderTable(); },
            changePage: (d) => { state.currentPage += d; window.app.renderTable(); },
            changeSort: (v) => { 
                state.sortOrder = (state.sortBy === v) ? (state.sortOrder === 'asc' ? 'desc' : 'asc') : (v === 'no' ? 'asc' : 'desc');
                state.sortBy = v; window.app.renderTable(); 
            },

            renderTable: () => {
                const tbody = document.getElementById('table-body');
                if(!tbody || state.activeTab !== 'data') return;
                let filtered = state.users.filter(u => (u.EmpName || '').toLowerCase().includes(state.searchTerm) && (state.selectedDataReward === '' || String(u.Reward) === String(state.selectedDataReward)));
                filtered.sort((a, b) => {
                    const vA = a[state.sortBy]; const vB = b[state.sortBy];
                    if (state.sortBy === 'no' || !isNaN(vA) && !isNaN(vB) && vA !== "" && vB !== "") return state.sortOrder === 'asc' ? (parseFloat(vA)||0) - (parseFloat(vB)||0) : (parseFloat(vB)||0) - (parseFloat(vA)||0);
                    return state.sortOrder === 'asc' ? String(vA || "").localeCompare(String(vB || ""), 'th', {numeric: true}) : String(vB || "").localeCompare(String(vA || ""), 'th', {numeric: true});
                });
                const paginated = filtered.slice((state.currentPage - 1) * state.rowsPerPage, state.currentPage * state.rowsPerPage);
                tbody.innerHTML = paginated.map((u) => `<tr class="hover:bg-indigo-50/30 transition border-b border-slate-100 font-bold"><td class="px-6 py-4 text-slate-600 font-normal">${u.no || '-'}</td><td class="px-6 py-4 text-slate-700 font-normal font-bold">${u.EmpName||'-'}</td><td class="px-6 py-4 font-normal font-bold">${u.Reward || '-'}</td><td class="px-6 py-4 text-indigo-600 font-normal font-bold">${formatDate(u.DateCheck)}</td><td class="px-6 py-4 text-slate-500 font-normal font-bold">${formatDate(u.DateLogin)}</td><td class="px-6 py-4 text-slate-500 font-normal font-bold">${formatDate(u.DateReward)}</td><td class="px-6 py-4 font-bold text-indigo-600 font-normal font-bold">${u.StatusReward || '-'}</td><td class="px-6 py-4 text-right font-bold"><button onclick="window.app.resetMemberData('${u.id}')" class="text-red-400 hover:text-red-600 transition p-1"><i data-lucide="trash-2" width="18"></i></button></td></tr>`).join('');
                if(document.getElementById('data-table-info')) document.getElementById('data-table-info').innerText = `แสดง ${paginated.length} จาก ${filtered.length} รายการ`;
                const pagin = document.getElementById('pagination-controls');
                if(pagin) pagin.innerHTML = `<button onclick="window.app.changePage(-1)" class="px-3 py-1 bg-white border rounded-md text-sm hover:bg-slate-50 font-bold" ${state.currentPage <= 1 ? 'disabled' : ''}>ย้อนกลับ</button><span class="text-sm self-center font-bold px-2">หน้า ${state.currentPage}</span><button onclick="window.app.changePage(1)" class="px-3 py-1 bg-white border rounded-md text-sm hover:bg-slate-50 font-bold" ${state.currentPage * state.rowsPerPage >= filtered.length ? 'disabled' : ''}>ถัดไป</button>`;
                lucide.createIcons();
            },

            openResetModal: () => {
                window.app.showLabelModal('Reset', 'ยืนยัน Reset Register?', 'พิมพ์ Reset เพื่อล้างข้อมูลการล็อกอินและผลการสุ่มทั้งหมด', 'orange', async () => {
                    try {
                        const snap = await getDocs(collection(db, finalCollectionPath));
                        const batch = writeBatch(db);
                        snap.docs.forEach(d => batch.update(d.ref, { DateLogin: "", StatusReward: "", DateReward: "", DateCheck: "" }));
                        await batch.commit();
                        window.app.showToast('รีเซ็ตสำเร็จ');
                    } catch(e) { window.app.showToast('เกิดข้อผิดพลาด', 'error'); }
                });
            },

            openDeleteModal: () => {
                window.app.showLabelModal('Delete', 'ลบข้อมูลพนักงานทั้งหมด?', 'พิมพ์ Delete เพื่อลบรายชื่อพนักงานทั้งหมดออกจากฐานข้อมูล', 'red', async () => {
                    try {
                        const snap = await getDocs(collection(db, finalCollectionPath));
                        const chunks = chunkArray(snap.docs, 400);
                        for(const chunk of chunks) {
                            const batch = writeBatch(db); chunk.forEach(d => batch.delete(d.ref)); await batch.commit();
                        }
                        window.app.showToast('ลบสำเร็จ');
                    } catch(e) { window.app.showToast('เกิดข้อผิดพลาด', 'error'); }
                });
            },

            openDeleteLabelsModal: () => {
                window.app.showLabelModal('Delete', 'ลบฉลากทั้งหมด?', 'พิมพ์ Delete เพื่อลบสลากทั้งหมดออกจากระบบและรีเซ็ตสถานะสุ่ม', 'red', async () => {
                    try {
                        const cardsSnap = await getDocs(collection(db, cardCollectionPath));
                        const chunks = chunkArray(cardsSnap.docs, 400);
                        for(const chunk of chunks) {
                            const batch = writeBatch(db); chunk.forEach(d => batch.delete(d.ref)); await batch.commit();
                        }
                        const usersSnap = await getDocs(collection(db, finalCollectionPath));
                        const userChunks = chunkArray(usersSnap.docs, 400);
                        for(const chunk of userChunks) {
                            const batch = writeBatch(db); chunk.forEach(d => batch.update(d.ref, { DateLogin: "", StatusReward: "", DateReward: "", CardNo: "" })); await batch.commit();
                        }
                        window.app.showToast('ลบฉลากสำเร็จ');
                    } catch(e) { window.app.showToast('เกิดข้อผิดพลาด', 'error'); }
                });
            },

            openCreateLabelsModal: () => {
                window.app.showLabelModal('Confirm', 'สร้างฉลากใหม่?', 'ยืนยันการสร้างสลากใหม่โดยอ้างอิงจากรายชื่อสมาชิกที่มีอยู่จริงในระบบ', 'indigo', async () => {
                    try {
                        await window.app.generateLabels();
                        window.app.showToast('สร้างฉลากใหม่สำเร็จ');
                    } catch(e) { window.app.showToast('เกิดข้อผิดพลาด', 'error'); }
                });
            },

            generateLabels: async () => {
                if (state.users.length === 0) { window.app.showToast('ยังไม่มีข้อมูลสมาชิก', 'error'); return; }
                const cardsSnap = await getDocs(collection(db, cardCollectionPath));
                const delChunks = chunkArray(cardsSnap.docs, 400);
                for(const chunk of delChunks) {
                    const batch = writeBatch(db); chunk.forEach(d => batch.delete(d.ref)); await batch.commit();
                }
                const groupCounters = {};
                const newCards = state.users.map(m => {
                    const groupKey = String(m.Reward || "ไม่ระบุกลุ่ม").trim();
                    groupCounters[groupKey] = (groupCounters[groupKey] || 0) + 1;
                    return { Reward: groupKey, rewardname: "", CardNo: String(groupCounters[groupKey]), EmpName: "", citizenId: "", Datetime: "" };
                });
                const chunks = chunkArray(newCards, 400);
                for(const chunk of chunks) {
                    const batch = writeBatch(db); chunk.forEach(c => batch.set(doc(collection(db, cardCollectionPath)), c)); await batch.commit();
                }
            },

            handleFileSelect: (e) => { const f = e.target.files[0]; if(f) { document.getElementById('file-name').innerText = f.name; document.getElementById('file-info').classList.remove('hidden'); document.getElementById('btn-import').disabled = false; } },
            clearFileSelection: () => { document.getElementById('file-upload').value = ''; document.getElementById('file-info').classList.add('hidden'); document.getElementById('btn-import').disabled = true; },
            processImport: async () => {
                const fileInput = document.getElementById('file-upload');
                const f = fileInput.files[0];
                if (!f) return;
                document.getElementById('import-progress').classList.remove('hidden');
                const bar = document.getElementById('import-bar');
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = f.name.endsWith('.json') ? JSON.parse(e.target.result) : csvToJson(e.target.result);
                        const total = data.length;
                        for (let i = 0; i < total; i += 400) {
                            const chunk = data.slice(i, i + 400);
                            const batch = writeBatch(db);
                            const batchPromises = chunk.map(async (item, idx) => {
                                const rawId = String(item.citizenId || "").replace(/-/g, '').trim();
                                const hashed = await sha256(rawId);
                                const currentNo = (i + idx + 1).toString();
                                const newRef = doc(collection(db, finalCollectionPath));
                                batch.set(newRef, { citizenId: hashed, no: currentNo, EmpName: item.EmpName || item.Name || "", Dateworking: item.Dateworking || "", Datework: item.Datework || "", Reward: item.Reward || "", DateLogin: item.DateLogin || "", StatusReward: item.StatusReward || "", DateReward: item.DateReward || "", DateCheck: item.DateCheck || "", importedAt: serverTimestamp() });
                            });
                            await Promise.all(batchPromises);
                            await batch.commit();
                            bar.style.width = Math.min(100, Math.round(((i + chunk.length) / total) * 100)) + '%';
                        }
                        window.app.showToast('นำเข้าข้อมูลเรียบร้อย'); window.app.clearFileSelection();
                    } catch (err) { window.app.showToast('ผิดพลาด: ' + err.message, 'error'); } finally { document.getElementById('import-progress').classList.add('hidden'); }
                };
                reader.readAsText(f);
            },

            refreshCharts: () => {
                const ctxPie = document.getElementById('registrationChart');
                if(ctxPie) {
                    if(window.regPie) window.regPie.destroy();
                    const regCount = state.users.filter(u => u.DateCheck && u.DateCheck !== "").length;
                    window.regPie = new Chart(ctxPie, { type:'doughnut', data:{ labels:['ลงทะเบียนแล้ว','ยังไม่ลงทะเบียน'], datasets:[{ data:[regCount, Math.max(0, state.users.length-regCount)], backgroundColor:['#10b981','#e2e8f0'] }] }, options:{ maintainAspectRatio:false } });
                }
                const ctxLine = document.getElementById('realtimeLineChart');
                if(ctxLine) {
                    if(window.regLine) window.regLine.destroy();
                    window.regLine = new Chart(ctxLine, { type:'line', data:{ labels:Array.from({length:24},(_,i)=>`${i}:00`), datasets:[{ label:'ความถี่การลงทะเบียน', data:state.hourlyData, borderColor:'#3b82f6', fill:true, tension:0.4 }] }, options:{ maintainAspectRatio:false } });
                }
                window.app.renderManualHistory();
            },

            renderManualHistory: () => {
                const tbody = document.getElementById('recent-activity-list');
                const feed = state.users.filter(u => u.DateCheck && u.DateCheck !== "").sort((a,b) => {
                    const tA = a.DateCheck?.toDate ? a.DateCheck.toDate() : new Date(a.DateCheck);
                    const tB = b.DateCheck?.toDate ? b.DateCheck.toDate() : new Date(b.DateCheck);
                    return tB - tA;
                }).slice(0, 10);
                if(tbody) {
                    tbody.innerHTML = feed.length ? feed.map(e => `<div class="p-3 bg-white rounded-lg text-sm shadow-sm border border-slate-100 mb-1 font-bold"><b class="text-slate-800 font-black">${e.EmpName || 'Unknown'}</b> <span class="text-slate-400 font-normal mx-1">กลุ่ม:</span> <span class="text-indigo-600">${e.Reward || '-'}</span> <div class="text-[10px] text-slate-400 mt-1 font-normal">ลงทะเบียนเมื่อ ${formatDate(e.DateCheck)}</div></div>`).join('') : '<div class="text-center text-slate-300 py-8 text-base font-medium">ไม่มีกิจกรรม</div>';
                }
            },

            resetMemberData: async (id) => {
                if(!confirm('ยืนยันการล้างข้อมูล?')) return;
                try { await updateDoc(doc(db, finalCollectionPath, id), { DateLogin: "", StatusReward: "", DateReward: "", DateCheck: "" }); window.app.showToast('สำเร็จ'); } catch(e) { window.app.showToast('ผิดพลาด', 'error'); }
            },

            resetLabelRecord: async (cardId) => {
                if(!confirm('ล้างข้อมูลฉลากใบนี้?')) return;
                try { await updateDoc(doc(db, cardCollectionPath, cardId), { EmpName: "", Datetime: "", citizenId: "" }); window.app.showToast('ล้างข้อมูลแล้ว'); } catch(e) { window.app.showToast('ผิดพลาด', 'error'); }
            },

            openEditRewardModal: (id, curRewardName) => {
                document.getElementById('edit-reward-input').value = curRewardName;
                document.getElementById('edit-reward-confirm-btn').onclick = async () => {
                    const newVal = document.getElementById('edit-reward-input').value.trim();
                    try { await updateDoc(doc(db, cardCollectionPath, id), { rewardname: newVal }); window.app.showToast('สำเร็จ'); window.app.closeEditRewardModal(); } catch(e) { window.app.showToast('ผิดพลาด', 'error'); }
                };
                document.getElementById('edit-reward-modal').classList.remove('hidden');
            },

            showLabelModal: (keyword, title, msg, color, cb) => {
                const m = document.getElementById('label-confirm-modal');
                const btn = document.getElementById('label-modal-confirm-btn');
                document.getElementById('label-modal-title').innerText = title;
                document.getElementById('label-modal-message').innerText = msg;
                const icon = document.getElementById('label-modal-icon');
                icon.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-${color}-100 text-${color}-600 font-bold`;
                icon.innerHTML = `<i data-lucide="${keyword==='Delete'?'trash-2':'check-circle'}" width="32"></i>`;
                document.getElementById('label-modal-input-container').classList.remove('hidden');
                const input = document.getElementById('label-modal-input');
                input.value = ''; input.placeholder = `พิมพ์ ${keyword} เพื่อยืนยัน`;
                btn.className = `flex-1 py-3 rounded-xl bg-${color==='red'?'red-600':(color==='orange'?'orange-600':'indigo-600')} text-white font-bold hover:opacity-90 transition font-bold`;
                btn.innerText = 'ยืนยัน';
                btn.onclick = async () => {
                    if(input.value !== keyword) return window.app.showToast('คำยืนยันไม่ถูกต้อง', 'error');
                    btn.disabled = true; btn.innerText = 'กำลังดำเนินการ...';
                    try { await cb(); window.app.closeLabelModal(); } finally { btn.disabled = false; btn.innerText = 'ยืนยัน'; }
                };
                m.classList.remove('hidden'); lucide.createIcons();
            },

            closeLabelModal: () => document.getElementById('label-confirm-modal').classList.add('hidden'),
            closeEditRewardModal: () => document.getElementById('edit-reward-modal').classList.add('hidden'),
            closeGeneralModal: () => document.getElementById('general-modal').classList.add('hidden'),
            onLabelGroupChange: (v) => { state.selectedLabelGroup = normalizeReward(v); state.labelPage = 1; window.app.renderLabelTable(); },
            onDataRewardFilterChange: (v) => { state.selectedDataReward = v; state.currentPage = 1; window.app.renderTable(); },
            handleSearch: (v) => { state.searchTerm = v.toLowerCase(); state.currentPage = 1; window.app.renderTable(); },
            changeRowsLimit: (v) => { state.rowsPerPage = parseInt(v); state.currentPage = 1; window.app.renderTable(); },
            changePage: (d) => { state.currentPage += d; window.app.renderTable(); },
            changeSort: (v) => { 
                state.sortOrder = (state.sortBy === v) ? (state.sortOrder === 'asc' ? 'desc' : 'asc') : (v === 'no' ? 'asc' : 'desc');
                state.sortBy = v; window.app.renderTable(); 
            },
            changeLogPage: (d) => { state.logPage += d; window.app.renderLogTable(); },
            changeLogSort: (k) => { state.logSortOrder = (state.logSortKey === k) ? (state.logSortOrder === 'asc' ? 'desc' : 'asc') : 'desc'; state.logSortKey = k; window.app.renderLogTable(); }
        };

        async function init() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                document.getElementById('status-indicator')?.classList.replace('bg-red-500', 'bg-green-500');
                if(document.getElementById('status-text')) document.getElementById('status-text').innerText = "Online";
                
                onSnapshot(collection(db, finalCollectionPath), (snap) => {
                    state.users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    document.getElementById('stat-checkin').innerText = snap.size.toLocaleString();
                    document.getElementById('manage-total-docs').innerText = snap.size.toLocaleString();
                    const regCount = state.users.filter(u => u.DateCheck && u.DateCheck !== "").length;
                    document.getElementById('stat-checkout').innerText = regCount.toLocaleString();
                    document.getElementById('stat-percent').innerText = snap.size > 0 ? ((regCount/snap.size)*100).toFixed(1) + '%' : '0%';
                    const hours = Array(24).fill(0);
                    state.users.forEach(u => { 
                        if(u.DateCheck) {
                            try {
                                let dObj = u.DateCheck.toDate ? u.DateCheck.toDate() : new Date(u.DateCheck);
                                if (!isNaN(dObj.getTime())) hours[dObj.getHours()]++;
                            } catch(e) {}
                        }
                    });
                    state.hourlyData = hours;
                    const uniqueRewards = [...new Set(state.users.map(u => String(u.Reward || "").trim()).filter(id => id !== ""))].sort((a,b) => a.localeCompare(b));
                    const dataSelect = document.getElementById('filter-data-reward');
                    if(dataSelect) {
                        const cur = dataSelect.value;
                        dataSelect.innerHTML = '<option value="">-- ทั้งหมด --</option>' + uniqueRewards.map(id => `<option value="${id}">${id}</option>`).join('');
                        dataSelect.value = uniqueRewards.includes(cur) ? cur : "";
                    }
                    window.app.renderTable(); window.app.renderDataSummary(); window.app.renderWinnersView(); window.app.refreshCharts();
                });

                onSnapshot(collection(db, cardCollectionPath), (snap) => {
                    state.cards = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    const groups = ["1000", "2000", "3000", "4000"];
                    const statistics = {};
                    groups.forEach(g => statistics[g] = { total: 0, used: 0 });

                    state.cards.forEach(d => { 
                        const groupKey = normalizeReward(d.Reward); 
                        if(statistics.hasOwnProperty(groupKey)) {
                            statistics[groupKey].total++;
                            if (d.Datetime && d.Datetime !== "") statistics[groupKey].used++;
                        }
                    });

                    groups.forEach(g => {
                        const stats = statistics[g];
                        const percent = stats.total > 0 ? Math.round((stats.used / stats.total) * 100) : 0;
                        if(document.getElementById(`card-total-${g}`)) document.getElementById(`card-total-${g}`).innerHTML = `${stats.total.toLocaleString()} <span class="text-xs font-normal opacity-70">สลาก</span>`;
                        if(document.getElementById(`card-used-${g}`)) document.getElementById(`card-used-${g}`).innerText = stats.used.toLocaleString();
                        if(document.getElementById(`card-percent-${g}`)) document.getElementById(`card-percent-${g}`).innerText = `${percent}%`;
                        if(document.getElementById(`card-bar-${g}`)) document.getElementById(`card-bar-${g}`).style.width = `${percent}%`;
                    });

                    const uniqueGroups = [...new Set(state.cards.map(c => normalizeReward(c.Reward)))].filter(id => id !== "").sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
                    const labelSelect = document.getElementById('label-group-select');
                    if(labelSelect) {
                        const cur = labelSelect.value;
                        labelSelect.innerHTML = '<option value="">รางวัลทั้งหมด</option>' + uniqueGroups.map(id => `<option value="${id}">${id}</option>`).join('');
                        labelSelect.value = cur || ""; 
                    }
                    window.app.renderLabelTable(); window.app.renderWinnersView();
                });

                onSnapshot(collection(db, logCollectionPath), (snap) => {
                    state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (state.activeTab === 'logs') window.app.renderLogTable();
                });

                window.app.switchTab(state.activeTab);
            } catch (e) { console.error(e); }
        }
        setInterval(() => { if(document.getElementById('current-time')) document.getElementById('current-time').innerText = new Date().toLocaleTimeString('th-TH'); }, 1000);
        init();
    </script>
</body>
</html>